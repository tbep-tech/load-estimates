---
output: 
  html_document
css: styles.css
---

# Tampa Bay load estimates {.tabset}

`r Sys.time()` 

Loading estimates for total nitrogen (tons / yr or tons / mo) and hydrologic (million m3 / yr) inputs to Tampa Bay.  All estimates from Janicki Environmental. Source content [here](https://github.com/tbep-tech/load-estimates).

```{r setup, message = F, warning = F, results = 'hide', echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F, fig.path = 'figs/', fig.path = 'figures/')

library(tidyverse)
library(lubridate)
library(plotly)
library(colorspace)
library(reactable)
library(downloadthis)
library(tools)
library(shiny)

data(tnanndat)
data(tnmosdat)
data(tnmosentdat)
data(totanndat)
data(npsdpsips)
data(npsdpsipsent)
data(npsmosludat)

source('R/funcs.R')

levs <- c('All Segments (- N. BCB)', 'Old Tampa Bay', 'Hillsborough Bay', 'Middle Tampa Bay', 'Lower Tampa Bay', 'Remainder Lower Tampa Bay')

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')
```

## Background 

Total nitrogen load estimates are partitioned into one of five categories by source: 

* __AD__: atmospheric deposition
* __DPS__: domestic point source
* __GWS__: groundwater source
* __IPS__: industrial point source
* __NPS__: nonpoint source

Source estimates for total nitrogen are shown annually from 1985 to present, by month from 2017 to 2020 (current reasonable assurance period), and by month from 2004 to 2020 for select sources (DPS reuse, DPS stormwater, IPS, NPS).  The totals tab shows annual results for total nitrogen, hydrologic load, and total nitrogen vs hydrologic load ratios. The load ratio plots show target ratios as horizontal lines that are applicable to each bay segment. 

Estimates are also assigned to one of five major bay segments in Tampa Bay: Old Tampa Bay, Hillsborough Bay, Middle Tampa Bay, Lower Tampa Bay, and the Remainder of Lower Tampa Bay.  The "Remainder of Lower Tampa Bay" includes the Manatee River, Terra Ceia Bay, and Boca Ciega Bay.  Estimates for all segments are also provided as the sum of loads across the five major bay segments and the remainder of Lower Tampa Bay.  Note that this does not include the northern portion of Boca Ciega Bay (i.e., __(- N. BCB)__ in the tables and plots).  

Annual load targets for total nitrogen (tons/yr) by major bay segments are as follows ([2009 RA Addendum](https://drive.google.com/file/d/10IjJAfcGFf007a5VdPXAUtUi4dx-cmsA/view)):

* Old Tampa Bay: 486 tons/yr
* Hillsborough Bay: 1451 tons/yr
* Middle Tampa Bay: 799 tons/yr
* Lower Tampa Bay:  349 tons/yr

```{r, out.width = '40%', fig.align = 'center', fig.cap='Major bay segments in Tampa Bay used to assign load estimates.  The "Remainder of Lower Tampa Bay" includes the Manatee River, Terra Ceia Bay, and Boca Ciega Bay. Figure courtest of Janicki Environmental, Inc.'}
knitr::include_graphics('figs/segmap.PNG')
```

## Total nitrogen (annual, 1985 - 2020) {.tabset .tabset-pills}

```{r}
column(12, 
  column(3, 
    tnanndat %>%
      download_this(
        output_name = "TN-annual",
        output_extension = ".xlsx",
        button_label = "Download plot data",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  )
)
```

<br></br>
<br></br>

### By source

```{r, out.width = '100%', out.height='850px'}
tnsrc_plo(tnanndat, xval = 'year', src = 'all')
```

### Table

```{r}
rct_tab(tnanndat, dtvar = 'year', typ = 'tn')
```

### Metadata

Data from the __Download plot data__ button includes the following: 

* __*year*__: year of the estimate
* __*bay_segment*__: the bay segment for the source/year estimate, one of Old Tampa Bay, Hillsborough Bay, Middle Tampa Bay, Lower Tampa Bay, Remainder of Lower Tampa Bay (Manatee River, Terra Ceia Bay, and Boca Ciega Bay South), and all segments as the sum of all (excluding Boca Ciega Bay North)
* __*source*__: total nitrogen source as atmospheric deposition (AD), domestic point source (DPS), groundwater source (GWS), industrial point source (IPS), and non-point source (NPS)
* __*tn_load*__: total nitrogen load in tons / year

## Total nitrogen (monthly, 2017 - 2020) {.tabset .tabset-pills}

```{r}
column(12,
  column(3, 
    tnmosdat %>%
      download_this(
        output_name = "TN-monthly",
        output_extension = ".xlsx",
        button_label = "Download plot data",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
    ), 
  column(3,
    tnmosentdat %>%
      download_this(
        output_name = "TN-entity-monthly",
        output_extension = ".xlsx",
        button_label = "Download entity data",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
    )     
)
```

<br></br>
<br></br>

### By source

```{r, out.width = '100%', out.height='850px'}
tnsrc_plo(tnmosdat, xval = 'date', src = 'all')
```

### Table

```{r}
rct_tab(tnmosdat, dtvar = 'date', typ = 'tn')
```

### Metadata

Data from the __Download plot data__ button includes the following: 

* __*year*__: year of the estimate
* __*month*__: month of the estimate
* __*bay_segment*__: the bay segment for the source/year estimate, one of Old Tampa Bay, Hillsborough Bay, Middle Tampa Bay, Lower Tampa Bay, Remainder of Lower Tampa Bay (Manatee River, Terra Ceia Bay, and Boca Ciega Bay South), and all segments as the sum of all (excluding Boca Ciega Bay North)
* __*source*__: total nitrogen source as atmospheric deposition (AD), domestic point source (DPS), groundwater source (GWS), industrial point source (IPS), and non-point source (NPS)
* __*tn_load*__: total nitrogen load in tons / month

Data from the __Download entity data__ button includes the following: 

* __*year*__: year of the estimate
* __*month*__: month of the estimate
* __*entity*__: entity responsible for the load, e.g., a specific wastewater treatment plant
* __*source*__: total nitrogen source as atmospheric deposition (AD), domestic point source (DPS), groundwater source (GWS), industrial point source (IPS), and non-point source (NPS)
* __*tn_load*__: total nitrogen load in tons / month

## Total nitrogen select sources (monthly, 2004 - 2020) {.tabset .tabset-pills}

```{r}
column(12, 
  column(3, 
    npsdpsips %>%
      download_this(
        output_name = "TN-select-sources-monthly",
        output_extension = ".xlsx",
        button_label = "Download plot data",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  ),
  column(3,
    npsdpsipsent %>%
      download_this(
        output_name = "TN-entity-monthly",
        output_extension = ".xlsx",
        button_label = "Download entity data",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  ),
  column(3,
    npsmosludat %>%
      download_this(
        output_name = "TN-lu-monthly",
        output_extension = ".xlsx",
        button_label = "Download NPS by land use",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  ) 
)
```

<br></br>
<br></br>

### By source

```{r, out.width = '100%', out.height='850px'}
tnsrc_plo(npsdpsips, xval = 'date', src = 'select')
```

### Table

```{r}
rct_tab(npsdpsips, dtvar = 'date', typ = 'tn')
```

### Metadata

Data from the __Download plot data__ button includes the following: 

* __*year*__: year of the estimate
* __*month*__: month of the estimate
* __*bay_segment*__: the bay segment for the source/year estimate, one of Old Tampa Bay, Hillsborough Bay, Middle Tampa Bay, Lower Tampa Bay, Remainder of Lower Tampa Bay (Manatee River, Terra Ceia Bay, and Boca Ciega Bay South), and all segments as the sum of all (excluding Boca Ciega Bay North)
* __*source*__: total nitrogen source as domestic point source reuse (DPS - reuse), domestic point source stormwater (DPS - stormwater), industrial point source (IPS), and non-point source (NPS)
* __*tn_load*__: total nitrogen load in tons / month

Data from the __Download entity data__ button includes the following: 

* __*year*__: year of the estimate
* __*month*__: month of the estimate
* __*entity*__: entity responsible for the load, e.g., a specific wastewater treatment plant
* __*source*__: total nitrogen source as atmospheric deposition (AD), domestic point source (DPS), groundwater source (GWS), industrial point source (IPS), and non-point source (NPS)
* __*tn_load*__: total nitrogen load in tons / month

Data from the __Download NPS by land use__ button includes the following: 

* __*year*__: year of the estimate
* __*month*__: month of the estimate
* __*bay_segment*__: the bay segment for the source/year estimate, one of Old Tampa Bay, Hillsborough Bay, Middle Tampa Bay, Lower Tampa Bay, Remainder of Lower Tampa Bay (Manatee River, Terra Ceia Bay, and Boca Ciega Bay South), and all segments as the sum of all (excluding Boca Ciega Bay North)
* __*land use*__: land use type associated with the load
* __*source*__: total nitrogen source as non-point source (NPS)
* __*tn_load*__: total nitrogen load in tons / month

## Totals {.tabset .tabset-pills}

```{r}
column(12, 
  column(3,
    totanndat %>%
      download_this(
        output_name = "hydro-annual",
        output_extension = ".xlsx",
        button_label = "Download plot data",
        button_type = "warning",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  )
)
```

<br></br>
<br></br>

### Total Nitrogen

```{r, out.width = '100%', out.height='850px'}
ldtot_plo(totanndat, yval = 'tn_load')
```

### Hydrology

```{r, out.width = '100%', out.height='850px'}
ldtot_plo(totanndat, yval = 'hy_load')
```

### Total Nitrogen vs Hydrology

```{r, out.width = '100%', out.height='850px'}
ldtot_plo(totanndat, yval = 'tnhy', addlns = T)
```

### Table 

```{r}
rct_tab(totanndat, dtvar = 'year', typ = 'tots')
```

### Metadata

Data from the __Download plot data__ button includes the following: 

* __*year*__: year of the estimate
* __*bay_segment*__: the bay segment for the source/year estimate, one of Old Tampa Bay, Hillsborough Bay, Middle Tampa Bay, Lower Tampa Bay, Remainder of Lower Tampa Bay (Manatee River, Terra Ceia Bay, and Boca Ciega Bay South), and all segments as the sum of all (excluding Boca Ciega Bay North)
* __*tn_load*__: total nitrogen load in tons / year
* __*hy_load*__: hydrologic load in million cubic meters / year
* __*tnhy*__: ratio between total nitrogen and hydrologic loads
